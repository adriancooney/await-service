#!/usr/bin/env babel-node --
import program from "commander";
import { exec } from "child_process"
import pkg from "../package.json";
import check, { DEFAULT_DELAY, DEFAULT_TIMEOUT } from "../src";

let command, argv = process.argv.slice();
const partition = argv.indexOf("--");
if(partition > -1) {
    command = argv.slice(partition + 1);
    argv = argv.slice(0, partition);
}

program.on("--help", function(){
    console.log([
        "  Examples:",
        "",
        "    $ prone tcp://google.com:80 -- echo \"Google is up!\"",
        "    $ prone redis rabbitmq && echo 'Hosts are up'",
        ""
    ].join("\n"));
});

program
    .version(pkg.version)
    .usage("<target ...>")
    .option("-t, --timeout <timeout>", `timeout after ms (default: ${DEFAULT_TIMEOUT}ms)`, parseInt)
    .option("-m, --max-attempts <attempts>", "maximum amount of attempts before failing", parseInt)
    .option("--delay <delay>", `the delay between healthchecks (default: ${DEFAULT_DELAY}ms)`, parseInt)
    .option("-d, --debug", "output debug logs")
    .parse(argv);

if(!program.args.length) {
    fail("Please specify some targets.");
}

log("starting healthchecks:")
log(" * " + program.args.join("\n * "));
Promise.all(program.args.map(target => {
    return check(target, {
        timeout: program.timeout,
        maxAttempts: program.maxAttempts,
        debug: program.debug,
        delay: program.delay
    });
})).then(({ time, attempts }) => {
    log("healthchecks completed successfully in " + time);
    if(command && command.length) {
        log("executing: $ " + command.join(" "));
        const cmd = exec(command.join(" "), {
            cwd: process.cwd,
            shell: process.env.SHELL,
            env: process.env
        });

        cmd.stdout.pipe(process.stdout);
        cmd.stderr.pipe(process.stderr);
        cmd.on("exit", process.exit);
    }
}).catch(fail);

function fail(message, exitCode = 1) {
    if(message instanceof Error) {
        message = message.message;
    }

    console.error("Error: " + message);
    process.exit(exitCode);
}

function log() {
    if(program.debug) {
        console.log.apply(console, arguments);
    }
}